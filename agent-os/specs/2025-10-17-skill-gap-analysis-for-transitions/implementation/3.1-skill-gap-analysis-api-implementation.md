# Task 3.1: Skill Gap Analysis API Endpoints

## Overview
**Task Reference:** Task Group 3.1 from `/Users/jonsiu/Projects/career-os/career-os-app/agent-os/specs/2025-10-17-skill-gap-analysis-for-transitions/tasks.md`
**Implemented By:** api-engineer
**Date:** 2025-10-20
**Status:** ⚠️ Blocked - Waiting for service implementations

### Task Description
Implement API endpoints for skill gap analysis functionality, enabling users to analyze skill gaps between their current skills and target role requirements, view historical analyses, and track progress toward skill acquisition goals.

## Implementation Status
**Status:** ⚠️ **BLOCKED** - Cannot proceed until Task Groups 2.2 and 2.3 are completed

### Blocking Dependencies
This task group requires the following services to be implemented first:

1. **SkillGapAnalyzer service** (Task Group 2.2)
   - Location: `src/lib/services/skill-gap-analyzer.ts`
   - Required methods:
     - `analyzeGap(resumeSkills[], targetSkills[], userAvailability: number)`
     - `prioritizeGaps(gaps[], learningVelocity: number)`
     - `estimateTimeline(gap, userAvailability, learningVelocity)`
     - `generateRoadmap(prioritizedGaps[], userAvailability)`

2. **TransferableSkillsMatcher service** (Task Group 2.3)
   - Location: `src/lib/services/transferable-skills-matcher.ts`
   - Required methods:
     - `findTransferableSkills(currentSkills[], targetSkills[], currentRole: string, targetRole: string)`
     - `explainTransfer(skillName: string, currentContext: string, targetContext: string)`
     - `calculateTransferConfidence(skill, explanation)` - returns 0-1 confidence score

### Current Blockers
- Task Group 2.2 (Multi-Factor Prioritization Algorithm) - Status: Unknown
- Task Group 2.3 (AI Transferable Skills Matcher) - Status: Completed ✅

**Note:** As of 2025-10-20, Task Group 2.3 has been completed. Only Task Group 2.2 remains as a blocking dependency.

## Endpoints Pending Implementation

### 1. POST /api/skill-gap/analyze
**Purpose:** Analyze skill gaps between resume and target role

**Request Body:**
```typescript
{
  resumeId: string;
  targetRole: string;
  targetRoleONetCode?: string;
  userAvailability: number; // hours per week
}
```

**Response:**
```typescript
{
  success: boolean;
  analysisId: string;
  criticalGaps: SkillGap[];
  niceToHaveGaps: SkillGap[];
  transferableSkills: TransferableSkill[];
  roadmap: RoadmapPhase[];
}
```

**Implementation Requirements:**
- Validate Clerk authentication
- Extract skills from resume using `AnalysisProvider.parseResumeContent()`
- Calculate content hash using pattern from `convex-analysis.ts`
- Check cache via `skillGapAnalyses.getByContentHash()`
- If cache miss:
  - Fetch O*NET skills via `ONetProvider.getOccupationSkills()`
  - Run prioritization via `SkillGapAnalyzer.prioritizeGaps()`
  - Run AI transferable skills via `TransferableSkillsMatcher.findTransferableSkills()`
- Save analysis to `skillGapAnalyses` table
- Return full analysis results

### 2. GET /api/skill-gap/[analysisId]
**Purpose:** Retrieve a specific analysis by ID

**Path Parameters:**
- `analysisId`: Analysis document ID

**Response:**
```typescript
{
  success: boolean;
  analysis: SkillGapAnalysis;
}
```

**Implementation Requirements:**
- Validate Clerk authentication
- Retrieve via `skillGapAnalyses.getById()`
- Verify user owns the analysis (security check)
- Return full analysis data

### 3. GET /api/skill-gap/history
**Purpose:** Get historical analyses for the current user

**Query Parameters:**
- `targetRole?`: Optional filter by target role

**Response:**
```typescript
{
  success: boolean;
  analyses: SkillGapAnalysis[];
  count: number;
}
```

**Implementation Requirements:**
- Get userId from Clerk session
- Retrieve via `skillGapAnalyses.getByUserId()` or `skillGapAnalyses.getHistoricalAnalyses()`
- Sort by `createdAt` descending
- Return array of historical analyses with metadata

### 4. POST /api/skill-gap/progress
**Purpose:** Update progress tracking based on Skills Tracker

**Request Body:**
```typescript
{
  analysisId: string;
}
```

**Response:**
```typescript
{
  success: boolean;
  completionProgress: number;
  closedGaps: number;
  totalGaps: number;
}
```

**Implementation Requirements:**
- Calculate `completionProgress` from Skills Tracker
- Query skills matching analysis gaps via `DatabaseProvider.getUserSkillsByStatus()`
- Progress = (completedSkillsCount / totalGapsCount) * 100
- Update via `skillGapAnalyses.updateProgress()`

## Files That Need to Be Created

### Test Files
```
src/app/api/skill-gap/__tests__/skill-gap-api.test.ts
```

**Test Requirements (2-8 focused tests):**
- Test POST /api/skill-gap/analyze with valid inputs
- Test authentication requirement (Clerk)
- Test cache hit scenario (existing contentHash)
- Test error handling (missing resume, invalid O*NET code)
- Limit to critical API contract tests only

### API Route Files
```
src/app/api/skill-gap/analyze/route.ts
src/app/api/skill-gap/[analysisId]/route.ts
src/app/api/skill-gap/history/route.ts
src/app/api/skill-gap/progress/route.ts
```

## Implementation Plan

### Phase 1: Service Integration (Once 2.2 is complete)
1. Import `SkillGapAnalyzer` and `TransferableSkillsMatcher` services
2. Verify service methods match expected signatures
3. Create integration layer if needed

### Phase 2: Core Analysis Endpoint
1. Implement POST /api/skill-gap/analyze
2. Follow pattern from `src/app/api/analysis/basic/route.ts` for authentication
3. Use existing `calculateContentHash()` from `src/lib/abstractions/providers/convex-analysis.ts`
4. Implement content hash caching using `skillGapAnalyses.getByContentHash()`
5. Orchestrate: skill extraction → O*NET lookup → gap analysis → prioritization → transferable skills → roadmap generation

### Phase 3: Supporting Endpoints
1. Implement GET /api/skill-gap/[analysisId] for retrieval
2. Implement GET /api/skill-gap/history for historical tracking
3. Implement POST /api/skill-gap/progress for progress updates

### Phase 4: Testing
1. Write 2-8 focused tests covering critical paths
2. Test authentication and authorization
3. Test cache hit/miss scenarios
4. Test error handling
5. Run tests and verify all pass

## Key Implementation Details

### Content Hash Caching Strategy
**Reuse pattern from:** `src/lib/abstractions/providers/convex-analysis.ts`

The caching strategy prevents redundant analyses when:
- Same resume content (detected via SHA-256 hash)
- Same target role
- Analysis is still valid

**Cache lookup flow:**
1. Calculate content hash from resume content + target role
2. Query `skillGapAnalyses.getByContentHash(resumeId, contentHash, targetRole)`
3. If found and not expired, return cached result
4. If not found or expired, run new analysis and cache

### Skills Tracker Integration
**Location:** `convex/skills.ts` (existing operations)

For progress tracking, the API will:
1. Query user's skills via existing Convex operations
2. Match skill names from analysis gaps to Skills Tracker entries
3. Count skills with status "mastered" or "practicing"
4. Calculate progress percentage
5. Update `completionProgress` field in analysis

### Authentication Pattern
**Follow pattern from:** `src/app/api/analysis/basic/route.ts`

All endpoints require Clerk authentication:
```typescript
const { userId } = auth();
if (!userId) {
  return NextResponse.json(
    { error: "Unauthorized" },
    { status: 401 }
  );
}
```

## Acceptance Criteria
**Will be met when:**
- [ ] All 4 API endpoints implemented
- [ ] 2-8 focused tests written and passing
- [ ] Authentication required on all endpoints
- [ ] Cache invalidation based on content hash working
- [ ] Progress tracking integrated with Skills Tracker
- [ ] Error handling follows existing patterns (400, 401, 404, 500)
- [ ] Response formats match API contract

## Dependencies on Other Task Groups

### Completed Dependencies
- ✅ Task Group 1.1: O*NET Cache (database layer complete)
- ✅ Task Group 1.2: Skill Gap Analysis Schema (database layer complete)
- ✅ Task Group 2.1: O*NET Provider Abstraction (provider available)
- ✅ Task Group 2.3: AI Transferable Skills Matcher (service available)

### Blocking Dependencies
- ⚠️ Task Group 2.2: Multi-Factor Prioritization Algorithm (service NOT available)

### Downstream Dependencies
- Task Group 3.3: Affiliate Recommendations API (blocked on this task)
- Task Group 4.1: Analysis Wizard Flow (blocked on this task for submission)
- Task Group 4.2: Visualization Components (blocked on this task for data)
- Task Group 4.4: Progress Dashboard (blocked on this task for progress endpoint)

## Next Steps
1. **Monitor Task Group 2.2 status** - Wait for SkillGapAnalyzer service implementation
2. **Review Task Group 2.2 implementation** - Verify service methods match expected signatures
3. **Begin implementation** - Once services are available, follow implementation plan above
4. **Coordinate with testing-engineer** - Ensure tests cover critical workflows
5. **Unblock Task Group 3.3** - Complete this task to enable affiliate recommendations

## Notes for api-engineer
- Database layer is complete and ready (Convex tables and operations exist)
- O*NET provider is complete and tested (Task Group 2.1)
- TransferableSkillsMatcher service is complete (Task Group 2.3)
- Only waiting on SkillGapAnalyzer service (Task Group 2.2)
- Existing patterns are well-established in `/api/analysis/` routes
- Implementation should proceed rapidly once dependencies are met
- Estimated time: 6-8 hours once unblocked
