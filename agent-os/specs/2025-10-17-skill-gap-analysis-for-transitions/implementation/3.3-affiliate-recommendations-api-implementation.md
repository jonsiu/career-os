# Task 3.3: Affiliate Recommendations API

## Overview
**Task Reference:** Task Group 3.3 from `/Users/jonsiu/Projects/career-os/career-os-app/agent-os/specs/2025-10-17-skill-gap-analysis-for-transitions/tasks.md`
**Implemented By:** api-engineer
**Date:** 2025-10-20
**Status:** ⚠️ Blocked - Waiting for skill gap analysis API and service

### Task Description
Implement affiliate course recommendation system that generates personalized learning resource recommendations based on skill gap analysis results. This includes integrating with affiliate partner APIs (Coursera, Udemy, LinkedIn Learning), generating affiliate tracking links, and tracking click-through for revenue analytics.

## Implementation Status
**Status:** ⚠️ **BLOCKED** - Cannot proceed until Task Group 3.1 is completed

### Blocking Dependencies
This task group requires:

1. **Task Group 3.1 completion** (Skill Gap Analysis API Endpoints)
   - Status: ⚠️ Blocked on Task Group 2.2
   - Reason: Need skill gap data to generate recommendations
   - Specifically requires: POST /api/skill-gap/analyze endpoint

2. **AffiliateRecommendationEngine service** (Part of this task group 3.3.2)
   - Location: `src/lib/services/affiliate-recommendations.ts`
   - Status: Not yet implemented
   - Required methods:
     - `getCourseRecommendations(skillGaps[], userPreferences?)`
     - `generateAffiliateLink(course, userId, analysisId, skillName)`
     - `prioritizeCourses(courses[], gap)` - prioritize by gap criticality, ratings
     - `trackAffiliateClick(analysisId, skillName, courseProvider)`

### Current Blockers
- Task Group 3.1 (Skill Gap Analysis API) must complete first
- Task Group 2.2 (Multi-Factor Prioritization) must complete to unblock 3.1
- AffiliateRecommendationEngine service must be implemented as part of this task

## Endpoints Pending Implementation

### 1. POST /api/recommendations/courses
**Purpose:** Get personalized course recommendations for skill gaps

**Request Body:**
```typescript
{
  analysisId: string;
  skillGaps: SkillGap[];
  userPreferences?: {
    providers?: string[];       // Filter by provider (Coursera, Udemy, etc.)
    maxPrice?: number;          // Maximum price filter
    preferredDuration?: string; // "short" | "medium" | "long"
    learningFormats?: string[]; // "video" | "interactive" | "reading"
  };
}
```

**Response:**
```typescript
{
  success: boolean;
  recommendations: CourseRecommendation[];
  disclosure: string;  // FTC-compliant disclosure text
}

interface CourseRecommendation {
  skillName: string;
  skillPriority: number;
  courses: Course[];
}

interface Course {
  title: string;
  provider: string;      // "Coursera" | "Udemy" | "LinkedIn Learning"
  url: string;           // Original course URL
  affiliateUrl: string;  // Affiliate tracking URL
  price: string;         // "Free" | "$XX.XX"
  rating: number;        // 0-5 stars
  reviewCount: number;
  estimatedHours: number;
  level: string;         // "Beginner" | "Intermediate" | "Advanced"
  topics: string[];
  isQuickWin: boolean;   // High priority, low time commitment
}
```

**Implementation Requirements:**
- Validate Clerk authentication
- For each skill gap, query affiliate partner APIs:
  - Coursera Partner API (priority)
  - Udemy Affiliate API
  - LinkedIn Learning API (if available, or manual curation for MVP)
- Generate affiliate links with unique tracking tags: `careerosapp-{userId}-{analysisId}-{skillName}`
- Prioritize: top 3 courses per skill, sorted by ratings and relevance
- Include free and paid options with clear labeling
- Return FTC-compliant disclosure text
- Handle API errors gracefully with fallback to cached data

### 2. POST /api/recommendations/track-click
**Purpose:** Track affiliate link clicks for analytics

**Request Body:**
```typescript
{
  analysisId: string;
  skillName: string;
  courseProvider: string;
  courseUrl: string;
  courseTitle?: string;
}
```

**Response:**
```typescript
{
  success: boolean;
  message: string;
}
```

**Implementation Requirements:**
- Validate Clerk authentication
- Increment `metadata.affiliateClickCount` in `skillGapAnalyses` table
- Log click event for analytics (timestamp, skill, provider, course)
- Track click-through rate (CTR) = clicks / impressions
- Return success confirmation

## Files That Need to Be Created

### Service Layer
```
src/lib/services/__tests__/affiliate-recommendations.test.ts
src/lib/services/affiliate-recommendations.ts
```

**Service Methods:**
- `getCourseRecommendations(skillGaps[], userPreferences?)`
- `generateAffiliateLink(course, userId, analysisId, skillName)`
- `prioritizeCourses(courses[], gap)` - prioritize by gap criticality, ratings
- `trackAffiliateClick(analysisId, skillName, courseProvider)`

### Test Files
```
src/app/api/recommendations/__tests__/recommendations-api.test.ts
```

**Test Requirements (2-8 focused tests):**
- Test POST /api/recommendations/courses with skill gaps
- Test affiliate link generation with tracking tags
- Test prioritization (top 3 courses per skill)
- Test click tracking (POST /api/recommendations/track-click)
- Limit to critical revenue-related tests only

### API Route Files
```
src/app/api/recommendations/courses/route.ts
src/app/api/recommendations/track-click/route.ts
```

## Implementation Plan

### Phase 1: Service Layer Implementation
1. Create `AffiliateRecommendationEngine` service class
2. Implement course recommendation logic
3. Implement affiliate link generation with tracking tags
4. Implement course prioritization algorithm
5. Write service tests (2-4 focused tests)

### Phase 2: Affiliate Partner Integration
**Priority 1: Coursera Partner API**
- Documentation: https://tech.coursera.org/app-platform/catalog/
- Integration: Search courses by skill keyword
- Data mapping: Extract title, price, rating, duration, level
- Affiliate links: Generate with tracking parameters

**Priority 2: Udemy Affiliate API**
- Documentation: https://www.udemy.com/developers/affiliate/
- Integration: Search courses by skill keyword
- Data mapping: Extract course metadata
- Affiliate links: Use Udemy affiliate program links

**Priority 3: LinkedIn Learning (Optional for MVP)**
- Manual curation fallback if API unavailable
- Or defer to post-MVP

### Phase 3: API Endpoints
1. Implement POST /api/recommendations/courses
2. Implement POST /api/recommendations/track-click
3. Follow authentication patterns from existing API routes
4. Add proper error handling (400, 401, 500, 503 for partner API failures)

### Phase 4: FTC Compliance
1. Add disclosure text to all recommendation responses
2. Disclosure text: "We may earn a commission from course purchases made through our links, at no additional cost to you."
3. Ensure disclosure is returned with every course recommendation
4. Document disclosure requirements for frontend team

### Phase 5: Testing
1. Write 2-8 focused tests covering critical paths
2. Test affiliate link generation (verify tracking tags)
3. Test click tracking (verify database updates)
4. Test prioritization algorithm (verify top 3 sorting)
5. Test partner API error handling
6. Run tests and verify all pass

## Key Implementation Details

### Affiliate Link Generation
**Tracking Tag Format:** `careerosapp-{userId}-{analysisId}-{skillName}`

**Example:**
```typescript
// Original course URL
https://www.coursera.org/learn/machine-learning

// Affiliate URL with tracking
https://www.coursera.org/learn/machine-learning?utm_source=careerosapp&utm_campaign=user123-analysis456-python&affiliateId=12345
```

**Implementation:**
```typescript
generateAffiliateLink(
  course: Course,
  userId: string,
  analysisId: string,
  skillName: string
): string {
  const trackingTag = `careerosapp-${userId}-${analysisId}-${skillName}`;
  const affiliateId = process.env.COURSERA_AFFILIATE_ID; // From env vars

  return `${course.url}?utm_source=careerosapp&utm_campaign=${trackingTag}&affiliateId=${affiliateId}`;
}
```

### Course Prioritization Algorithm
**Factors:**
1. Gap criticality (from skill gap analysis priority score)
2. Course rating (4.5+ stars preferred)
3. Review count (social proof)
4. Price (prefer free options when available)
5. Estimated hours (prefer shorter for quick wins)

**Algorithm:**
```typescript
prioritizeCourses(courses: Course[], gap: SkillGap): Course[] {
  return courses
    .sort((a, b) => {
      // Weighted scoring
      const scoreA =
        (a.rating / 5) * 0.35 +           // 35% weight on rating
        (Math.min(a.reviewCount, 10000) / 10000) * 0.25 + // 25% weight on reviews
        (a.price === "Free" ? 1 : 0.5) * 0.20 +           // 20% weight on price
        (gap.priorityScore / 100) * 0.20;                 // 20% weight on gap priority

      const scoreB = // ... same calculation

      return scoreB - scoreA; // Higher score first
    })
    .slice(0, 3); // Top 3 only
}
```

### Click Tracking Implementation
**Database Schema:** Store in `skillGapAnalyses.metadata.affiliateClickCount`

**Tracking logic:**
```typescript
async trackAffiliateClick(
  analysisId: string,
  skillName: string,
  courseProvider: string
) {
  // Increment click count in metadata
  await database.updateSkillGapAnalysis(analysisId, {
    metadata: {
      affiliateClickCount: (existing.metadata.affiliateClickCount || 0) + 1,
      lastClickedAt: Date.now(),
      clicksBySkill: {
        ...existing.metadata.clicksBySkill,
        [skillName]: (existing.metadata.clicksBySkill?.[skillName] || 0) + 1
      },
      clicksByProvider: {
        ...existing.metadata.clicksByProvider,
        [courseProvider]: (existing.metadata.clicksByProvider?.[courseProvider] || 0) + 1
      }
    }
  });
}
```

### FTC Disclosure Requirements
**Required by:** Federal Trade Commission (FTC) guidelines for affiliate marketing

**Disclosure Text:**
```
We may earn a commission from course purchases made through our links, at no additional cost to you.
```

**Placement:**
- Must be displayed prominently before user clicks affiliate links
- Include in API response for frontend to display
- Use info icon with tooltip for detailed explanation

## Affiliate Partner Integration Details

### Coursera Partner API
**Base URL:** `https://api.coursera.org/api`
**Authentication:** API key (from env: `COURSERA_API_KEY`)
**Affiliate Program:** Coursera Affiliate Program

**Endpoints to use:**
- `GET /courses.v1?q=search&query={skill}` - Search courses
- `GET /courses.v1/{courseId}` - Get course details

**Rate Limits:** 1000 requests/day (MVP acceptable)

### Udemy Affiliate API
**Base URL:** `https://www.udemy.com/api-2.0`
**Authentication:** Client ID and Client Secret (from env: `UDEMY_CLIENT_ID`, `UDEMY_CLIENT_SECRET`)
**Affiliate Program:** Udemy Affiliate Program

**Endpoints to use:**
- `GET /courses/?search={skill}` - Search courses
- `GET /courses/{courseId}` - Get course details

**Rate Limits:** 2000 requests/day (MVP acceptable)

### LinkedIn Learning (Optional)
**Status:** Manual curation fallback for MVP
**Reason:** LinkedIn Learning API requires enterprise partnership
**Approach:** Curate top courses manually per skill category
**Future:** Integrate API if partnership obtained

## Acceptance Criteria
**Will be met when:**
- [ ] AffiliateRecommendationEngine service implemented and tested
- [ ] 2 API endpoints implemented (courses, track-click)
- [ ] 2-8 focused tests written and passing
- [ ] Affiliate link generation with unique tracking tags working
- [ ] Top 3 courses per skill gap returned
- [ ] Click-through tracking persisting to database (CRITICAL for revenue)
- [ ] FTC-compliant disclosure included in all responses
- [ ] Error handling for partner API failures (fallback to cache)
- [ ] At least Coursera integration working (Udemy optional for MVP)

## Dependencies on Other Task Groups

### Blocking Dependencies
- ⚠️ Task Group 3.1: Skill Gap Analysis API (blocked on Task Group 2.2)
- ⚠️ Task Group 2.2: Multi-Factor Prioritization (needed to unblock 3.1)

### Completed Dependencies
- ✅ Task Group 1.2: Skill Gap Analysis Schema (database ready for metadata tracking)

### Downstream Dependencies
- Task Group 4.3: Course Recommendations UI (blocked on this task)
- Task Group 5.3: Revenue Analytics (blocked on this task for click tracking data)

## Revenue Impact
**CRITICAL:** This task is directly tied to revenue generation

**Revenue Targets (from spec):**
- Affiliate click-through rate (CTR): 45%+ target
- Affiliate conversion rate: 8-12% target
- Revenue per analysis: $3-5 target

**Success Metrics:**
- Track CTR = (clicks / impressions) via `metadata.affiliateClickCount`
- Track conversion rate = (enrollments / clicks) if partner webhooks available
- Monitor revenue per analysis = CTR × conversion × avg commission

## Next Steps
1. **Monitor Task Group 3.1 status** - Wait for skill gap analysis API completion
2. **Begin service implementation** - Can start AffiliateRecommendationEngine in parallel
3. **Set up affiliate partnerships** - Register for Coursera and Udemy affiliate programs
4. **Obtain API credentials** - Get API keys for Coursera and Udemy (add to env vars)
5. **Review partner API documentation** - Study rate limits, data formats, error handling
6. **Coordinate with ui-designer** - Ensure Task Group 4.3 understands API contract
7. **Coordinate with testing-engineer** - Ensure click tracking is tested in Task Group 5.1

## Notes for api-engineer
- Can begin service layer implementation while waiting for Task Group 3.1
- Service implementation is independent of API layer
- Focus on Coursera integration first (highest quality courses)
- Udemy integration secondary (larger catalog, lower average quality)
- LinkedIn Learning deferred to post-MVP
- Click tracking is CRITICAL for revenue analytics - test thoroughly
- FTC disclosure is legally required - do not skip
- Estimated time: 4-6 hours once unblocked
